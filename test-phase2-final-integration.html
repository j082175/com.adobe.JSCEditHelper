<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Final Integration Test - JSC Edit Helper DI System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2d2d2d;
            color: #ffffff;
            margin: 20px;
            line-height: 1.6;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #3a3a3a;
            border-radius: 8px;
        }
        .module-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #3a3a3a;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .module-card {
            background-color: #4a4a4a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #555;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background-color: #28a745; }
        .status-partial { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .dependencies {
            margin-top: 10px;
            font-size: 0.9em;
            color: #cccccc;
        }
        .dependency-item {
            display: inline-block;
            margin: 2px 5px;
            padding: 3px 8px;
            background-color: #555;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .dependency-di { background-color: #28a745; }
        .dependency-legacy { background-color: #6c757d; }
        .test-button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #005a9e;
        }
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background-color: #4a4a4a;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .communication-test {
            background-color: #3a3a3a;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #2a2a2a;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§ª Phase 2 Final Integration Test</h1>
            <p>ì „ì²´ DI ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸ ë° ê²€ì¦</p>
            <div>
                <button class="test-button" onclick="runFullSystemTest()">ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</button>
                <button class="test-button" onclick="testCrossModuleCommunication()">ğŸ”„ ëª¨ë“ˆ ê°„ í†µì‹  í…ŒìŠ¤íŠ¸</button>
                <button class="test-button" onclick="refreshModuleStatus()">ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>

        <!-- ì‹œìŠ¤í…œ í†µê³„ -->
        <div class="stats-section" id="systemStats">
            <div class="stat-card">
                <div class="stat-number" id="totalModules">0</div>
                <div>ì´ ëª¨ë“ˆ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="diEnabledModules">0</div>
                <div>DI í™œì„±í™” ëª¨ë“ˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="legacyModules">0</div>
                <div>ë ˆê±°ì‹œ ëª¨ë“œ ëª¨ë“ˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="diCoverage">0%</div>
                <div>DI ì ìš©ë¥ </div>
            </div>
        </div>

        <!-- ëª¨ë“ˆë³„ ìƒíƒœ -->
        <div class="module-section">
            <h2>ğŸ“¦ ëª¨ë“ˆë³„ DI ìƒíƒœ</h2>
            <div id="moduleStatus"></div>
        </div>

        <!-- ì˜ì¡´ì„± ë„¤íŠ¸ì›Œí¬ -->
        <div class="module-section">
            <h2>ğŸ”— ì˜ì¡´ì„± ë„¤íŠ¸ì›Œí¬</h2>
            <div id="dependencyNetwork"></div>
        </div>

        <!-- í¬ë¡œìŠ¤ ëª¨ë“ˆ í†µì‹  í…ŒìŠ¤íŠ¸ -->
        <div class="module-section">
            <h2>ğŸ”„ í¬ë¡œìŠ¤ ëª¨ë“ˆ í†µì‹  í…ŒìŠ¤íŠ¸</h2>
            <div id="communicationTests"></div>
        </div>

        <!-- ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ -->
        <div class="module-section">
            <h2>ğŸ“Š ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
            <div id="systemTestResults"></div>
        </div>
    </div>

    <!-- í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="js/di-container.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/state-manager.js"></script>
    <script src="js/communication.js"></script>
    <script src="js/event-manager.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/sound-engine.js"></script>
    <script src="js/audio-file-processor.js"></script>
    <script src="js/clip-time-calculator.js"></script>

    <script>
        let testResults = {};
        let moduleStatuses = {};

        // ëª¨ë“ˆ ëª©ë¡ ì •ì˜
        const modules = [
            'JSCUtils',
            'JSCUIManager', 
            'JSCStateManager',
            'JSCCommunication',
            'JSCEventManager',
            'JSCErrorHandler',
            'SoundEngine',
            'AudioFileProcessor',
            'ClipTimeCalculator'
        ];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Phase 2 Final Integration Test ì‹œì‘');
            initializeTest();
        });

        function initializeTest() {
            // DI ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            if (window.DI) {
                console.log('âœ“ DI Container ì‚¬ìš© ê°€ëŠ¥');
            } else {
                console.error('âœ— DI Container ì—†ìŒ');
            }

            // ì´ˆê¸° ëª¨ë“ˆ ìƒíƒœ ìˆ˜ì§‘
            refreshModuleStatus();
        }

        function refreshModuleStatus() {
            console.log('ëª¨ë“ˆ ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì¤‘...');
            moduleStatuses = {};

            modules.forEach(moduleName => {
                const module = window[moduleName];
                if (module) {
                    let status = {
                        available: true,
                        hasDIStatus: typeof module.getDIStatus === 'function',
                        diInfo: null
                    };

                    if (status.hasDIStatus) {
                        try {
                            status.diInfo = module.getDIStatus();
                        } catch (e) {
                            console.warn(`${moduleName} getDIStatus ì˜¤ë¥˜:`, e);
                            status.diInfo = { error: e.message };
                        }
                    }

                    moduleStatuses[moduleName] = status;
                } else {
                    moduleStatuses[moduleName] = { available: false };
                }
            });

            updateUI();
        }

        function updateUI() {
            updateSystemStats();
            updateModuleStatusDisplay();
            updateDependencyNetwork();
        }

        function updateSystemStats() {
            const totalModules = modules.length;
            let diEnabled = 0;
            let legacy = 0;

            Object.values(moduleStatuses).forEach(status => {
                if (status.available && status.diInfo) {
                    if (status.diInfo.isDIAvailable) {
                        diEnabled++;
                    } else {
                        legacy++;
                    }
                }
            });

            const diCoverage = totalModules > 0 ? Math.round((diEnabled / totalModules) * 100) : 0;

            document.getElementById('totalModules').textContent = totalModules;
            document.getElementById('diEnabledModules').textContent = diEnabled;
            document.getElementById('legacyModules').textContent = legacy;
            document.getElementById('diCoverage').textContent = diCoverage + '%';
        }

        function updateModuleStatusDisplay() {
            const container = document.getElementById('moduleStatus');
            container.innerHTML = '';

            modules.forEach(moduleName => {
                const status = moduleStatuses[moduleName];
                const card = document.createElement('div');
                card.className = 'module-card';

                let statusClass = 'status-error';
                let statusText = 'ì‚¬ìš© ë¶ˆê°€';

                if (status.available) {
                    if (status.diInfo) {
                        statusClass = status.diInfo.isDIAvailable ? 'status-ready' : 'status-partial';
                        statusText = status.diInfo.containerInfo || (status.diInfo.isDIAvailable ? 'DI í™œì„±' : 'ë ˆê±°ì‹œ ëª¨ë“œ');
                    } else {
                        statusClass = 'status-partial';
                        statusText = 'ìƒíƒœ í™•ì¸ ë¶ˆê°€';
                    }
                }

                card.innerHTML = `
                    <div>
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${moduleName}</strong>
                        <span style="float: right; color: #999;">${statusText}</span>
                    </div>
                    ${status.available && status.diInfo && status.diInfo.dependencies ? `
                        <div class="dependencies">
                            ì˜ì¡´ì„±: ${status.diInfo.dependencies.map(dep => `
                                <span class="dependency-item ${dep.includes('(DI)') ? 'dependency-di' : 'dependency-legacy'}">${dep}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                container.appendChild(card);
            });
        }

        function updateDependencyNetwork() {
            const container = document.getElementById('dependencyNetwork');
            const networkInfo = analyzeDependencyNetwork();
            
            container.innerHTML = `
                <div class="module-card">
                    <h4>ì˜ì¡´ì„± ë¶„ì„</h4>
                    <p>ì´ ì˜ì¡´ì„± ì—°ê²°: <strong>${networkInfo.totalConnections}</strong></p>
                    <p>DI ì—°ê²°: <strong>${networkInfo.diConnections}</strong></p>
                    <p>ë ˆê±°ì‹œ ì—°ê²°: <strong>${networkInfo.legacyConnections}</strong></p>
                    <p>DI ì—°ê²°ë¥ : <strong>${networkInfo.diCoverage}%</strong></p>
                </div>
            `;
        }

        function analyzeDependencyNetwork() {
            let totalConnections = 0;
            let diConnections = 0;
            let legacyConnections = 0;

            Object.values(moduleStatuses).forEach(status => {
                if (status.available && status.diInfo && status.diInfo.dependencies) {
                    status.diInfo.dependencies.forEach(dep => {
                        totalConnections++;
                        if (dep.includes('(DI)')) {
                            diConnections++;
                        } else {
                            legacyConnections++;
                        }
                    });
                }
            });

            const diCoverage = totalConnections > 0 ? Math.round((diConnections / totalConnections) * 100) : 0;

            return {
                totalConnections,
                diConnections,
                legacyConnections,
                diCoverage
            };
        }

        function testCrossModuleCommunication() {
            console.log('í¬ë¡œìŠ¤ ëª¨ë“ˆ í†µì‹  í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            const tests = [
                {
                    name: 'DI Container ì„œë¹„ìŠ¤ í•´ê²°',
                    test: () => {
                        if (!window.DI) return { success: false, message: 'DI Container ì—†ìŒ' };
                        
                        const utilsService = window.DI.getSafe('JSCUtils');
                        const uiService = window.DI.getSafe('JSCUIManager');
                        
                        return {
                            success: !!(utilsService && uiService),
                            message: `Utils: ${!!utilsService}, UI: ${!!uiService}`
                        };
                    }
                },
                {
                    name: 'ëª¨ë“ˆ ê°„ DI í†µì‹ ',
                    test: () => {
                        try {
                            // UI Managerì—ì„œ Utils ì„œë¹„ìŠ¤ ì‚¬ìš© í…ŒìŠ¤íŠ¸
                            if (window.JSCUIManager && window.JSCUIManager.getDIStatus) {
                                const diStatus = window.JSCUIManager.getDIStatus();
                                return {
                                    success: true,
                                    message: `DI ìƒíƒœ: ${diStatus.isDIAvailable ? 'í™œì„±' : 'ë¹„í™œì„±'}`
                                };
                            }
                            return { success: false, message: 'UI Manager DI ìƒíƒœ í™•ì¸ ë¶ˆê°€' };
                        } catch (e) {
                            return { success: false, message: e.message };
                        }
                    }
                },
                {
                    name: 'Error Handler í†µí•©',
                    test: () => {
                        try {
                            if (window.JSCErrorHandler && window.JSCErrorHandler.getDIStatus) {
                                const diStatus = window.JSCErrorHandler.getDIStatus();
                                return {
                                    success: true,
                                    message: `Error Handler DI: ${diStatus.isDIAvailable ? 'í™œì„±' : 'ë¹„í™œì„±'}`
                                };
                            }
                            return { success: false, message: 'Error Handler ì—†ìŒ' };
                        } catch (e) {
                            return { success: false, message: e.message };
                        }
                    }
                },
                {
                    name: 'Sound Engine í†µí•©',
                    test: () => {
                        try {
                            if (window.SoundEngine && window.SoundEngine.getDIStatus) {
                                const diStatus = window.SoundEngine.getDIStatus();
                                return {
                                    success: true,
                                    message: `Sound Engine DI: ${diStatus.isDIAvailable ? 'í™œì„±' : 'ë¹„í™œì„±'}`
                                };
                            }
                            return { success: false, message: 'Sound Engine ì—†ìŒ' };
                        } catch (e) {
                            return { success: false, message: e.message };
                        }
                    }
                }
            ];

            const container = document.getElementById('communicationTests');
            container.innerHTML = '';

            tests.forEach(testCase => {
                const result = testCase.test();
                const testDiv = document.createElement('div');
                testDiv.className = 'communication-test';
                testDiv.innerHTML = `
                    <div>
                        <span class="status-indicator ${result.success ? 'status-ready' : 'status-error'}"></span>
                        <strong>${testCase.name}</strong>
                    </div>
                    <div class="test-result">${result.message}</div>
                `;
                container.appendChild(testDiv);
            });
        }

        function runFullSystemTest() {
            console.log('ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
            
            const results = {
                timestamp: new Date().toISOString(),
                diContainer: !!window.DI,
                modulesLoaded: 0,
                modulesWithDI: 0,
                totalDependencies: 0,
                diDependencies: 0,
                tests: []
            };

            // ëª¨ë“ˆ ë¡œë“œ ìƒíƒœ í™•ì¸
            modules.forEach(moduleName => {
                if (window[moduleName]) {
                    results.modulesLoaded++;
                    
                    const status = moduleStatuses[moduleName];
                    if (status && status.diInfo && status.diInfo.isDIAvailable) {
                        results.modulesWithDI++;
                    }
                    
                    if (status && status.diInfo && status.diInfo.dependencies) {
                        status.diInfo.dependencies.forEach(dep => {
                            results.totalDependencies++;
                            if (dep.includes('(DI)')) {
                                results.diDependencies++;
                            }
                        });
                    }
                }
            });

            // ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
            const systemTests = [
                {
                    name: 'DI Container ì´ˆê¸°í™”',
                    success: !!window.DI,
                    message: window.DI ? 'DI Container í™œì„±í™”ë¨' : 'DI Container ì—†ìŒ'
                },
                {
                    name: 'í•µì‹¬ ëª¨ë“ˆ ë¡œë“œ',
                    success: results.modulesLoaded >= 5,
                    message: `${results.modulesLoaded}/${modules.length} ëª¨ë“ˆ ë¡œë“œë¨`
                },
                {
                    name: 'DI ì ìš©ë¥ ',
                    success: (results.modulesWithDI / results.modulesLoaded) >= 0.7,
                    message: `${Math.round((results.modulesWithDI / results.modulesLoaded) * 100)}% DI ì ìš©`
                },
                {
                    name: 'ì˜ì¡´ì„± DI ì „í™˜ìœ¨',
                    success: results.totalDependencies > 0 && (results.diDependencies / results.totalDependencies) >= 0.5,
                    message: `${Math.round((results.diDependencies / results.totalDependencies) * 100)}% ì˜ì¡´ì„±ì´ DIë¡œ ì „í™˜ë¨`
                }
            ];

            results.tests = systemTests;

            // ê²°ê³¼ í‘œì‹œ
            const container = document.getElementById('systemTestResults');
            container.innerHTML = `
                <div class="test-result">
=== Phase 2 Final Integration Test Results ===
í…ŒìŠ¤íŠ¸ ì‹œê°„: ${results.timestamp}

DI Container: ${results.diContainer ? 'âœ“ í™œì„±í™”ë¨' : 'âœ— ë¹„í™œì„±í™”ë¨'}
ëª¨ë“ˆ ë¡œë“œ: ${results.modulesLoaded}/${modules.length}
DI ì ìš© ëª¨ë“ˆ: ${results.modulesWithDI}/${results.modulesLoaded}
ì´ ì˜ì¡´ì„±: ${results.totalDependencies}
DI ì˜ì¡´ì„±: ${results.diDependencies}

í…ŒìŠ¤íŠ¸ ê²°ê³¼:
${systemTests.map(test => `${test.success ? 'âœ“' : 'âœ—'} ${test.name}: ${test.message}`).join('\n')}

ì „ì²´ í‰ê°€: ${systemTests.every(test => test.success) ? 'âœ… ì„±ê³µ - Phase 2 DI ì „í™˜ ì™„ë£Œ!' : 'âš ï¸  ì¼ë¶€ í•­ëª© ë¯¸ì™„ì„±'}
                </div>
            `;

            // ì½˜ì†”ì—ë„ ì¶œë ¥
            console.log('Phase 2 Final Integration Test ì™„ë£Œ:', results);
        }
    </script>
</body>
</html>